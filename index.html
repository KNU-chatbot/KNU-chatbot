<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê²½ë¶ëŒ€í•™êµ ì „ê¸°ê³µí•™ê³¼ ì±—ë´‡</title>
  <style>
    /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ... */
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-title">
        <img alt="KNU ë¡œê³ " class="logo" src="knu_logo.jpg"/>
        <h1>ê²½ë¶ëŒ€í•™êµ ì „ê¸°ê³µí•™ê³¼ ì±—ë´‡</h1>
      </div>
      <button id="reset-btn" title="ì±„íŒ… ì´ˆê¸°í™”">ğŸ—‘ï¸</button>
    </div>
  </header>
  <div class="recommend-box">
    <button class="recommend-btn" onclick="sendRecommendedQuestion('ì¡¸ì—… ìš”ê±´ì´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?')">ğŸ“ ì¡¸ì—… ìš”ê±´</button>
    <button class="recommend-btn" onclick="sendRecommendedQuestion('êµìˆ˜ë‹˜ ì´ë©”ì¼ì€ ì–´ë””ì„œ í™•ì¸í•´ìš”?')">ğŸ“¬ êµìˆ˜ë‹˜ ì´ë©”ì¼</button>
  </div>
  <div class="container">
    <div id="chat-box"></div>
  </div>
  <!-- íŒŒì¼ ì—…ë¡œë“œ UI ì¶”ê°€ -->
  <div class="input-area" style="flex-direction: column; align-items: stretch;">
    <form id="upload-form" style="margin-bottom: 8px; display:flex; gap:8px;">
      <input type="file" id="file-input" accept=".pdf,.jpg,.jpeg,.png" />
      <button type="submit" id="upload-btn">íŒŒì¼ ì—…ë¡œë“œ</button>
      <span id="upload-status" style="margin-left:10px; color:#3366ff;"></span>
    </form>
    <div class="input-area-inner">
      <textarea id="user-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Shift+Enter ì¤„ë°”ê¿ˆ)" rows="1"></textarea>
      <button id="send-btn" onclick="sendMessage()">â¤</button>
    </div>
  </div>
<script>
  // sessionId(ì±— ì„¸ì…˜)ì™€ fileSessionId(íŒŒì¼ ì„¸ì…˜) ë¶„ë¦¬
  const sessionId = crypto.randomUUID();
  let fileSessionId = null; // íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ ì‹œ ë°˜í™˜ë˜ëŠ” ì„¸ì…˜ID

  // ê¸°ì¡´ ë³€ìˆ˜ ë° í•¨ìˆ˜ë“¤ ê·¸ëŒ€ë¡œ...
  let controller = null;
  let loadingMessage = null;
  let loadingTimer = null;
  let streamReader = null;

  function preserveWhitespace(text) {
    // ... (ìƒëµ, ê¸°ì¡´ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ)
    text = text.replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
    text = text.replace(/(https?:\/\/[^\s<>(){}\[\]'"]+[\w/#?&=~%@-])/g, function(url) {
      return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });
    text = text.replace(/ {2,}/g, function(space) {
      return "&nbsp;".repeat(space.length);
    });
    text = text.replace(/\n/g, "<br>");
    return text;
  }

  function scrollToBottom() {
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  function cancelRequest() {
    // ... (ìƒëµ, ê¸°ì¡´ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ)
    if (!loadingMessage) return;
    if (controller) controller.abort();
    if (streamReader) streamReader.cancel();
    if (loadingMessage && loadingMessage.parentNode) {
      loadingMessage.parentNode.removeChild(loadingMessage);
      loadingMessage = null;
    }
    appendBotMessage("âš ï¸ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆì–´ìš”.");
    hideLoading();
    scrollToBottom();
    clearTimeout(loadingTimer);
  }

  window.onload = function () {
    initChat();
    const inputElem = document.getElementById("user-input");
    inputElem.addEventListener("keydown", function (event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });
    document.getElementById("reset-btn").addEventListener("click", () => {
      initChat();
    });

    // íŒŒì¼ ì—…ë¡œë“œ í¼ ì´ë²¤íŠ¸ ì¶”ê°€!
    document.getElementById('upload-form').addEventListener('submit', handleFileUpload);
  };

  function initChat() {
    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML = "";
    const intro = document.createElement("div");
    intro.className = "chat-message bot";
    intro.innerHTML = `
      <div class="avatar">ğŸ¤–</div>
      <div class="chat-bubble bot-intro">âš¡ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”! ê²½ë¶ëŒ€í•™êµ ì „ê¸°ê³µí•™ê³¼ ì±—ë´‡ì…ë‹ˆë‹¤.<br><span style="font-weight:normal;color:#0066bb">PDF/ì´ë¯¸ì§€ íŒŒì¼ë„ ì—…ë¡œë“œí•˜ì—¬ ì§ˆë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></div>
    `;
    chatBox.appendChild(intro);
    scrollToBottom();
    // íŒŒì¼ ì„¸ì…˜ë„ ë¦¬ì…‹!
    fileSessionId = null;
    document.getElementById("upload-status").textContent = "";
    document.getElementById("file-input").value = "";
  }

  function showLoading() {
    document.getElementById("user-input").disabled = true;
    document.getElementById("send-btn").disabled = true;
  }
  function hideLoading() {
    document.getElementById("user-input").disabled = false;
    document.getElementById("send-btn").disabled = false;
  }

  function appendUserMessage(text) {
    const chatBox = document.getElementById("chat-box");
    const msg = document.createElement("div");
    msg.className = "chat-message user";
    msg.innerHTML = `<div class="avatar">ğŸ™‹â€â™‚ï¸</div><div class="chat-bubble">${preserveWhitespace(text)}</div>`;
    chatBox.appendChild(msg);
    scrollToBottom();
  }

  function appendBotMessage(text) {
    const chatBox = document.getElementById("chat-box");
    const msg = document.createElement("div");
    msg.className = "chat-message bot";
    msg.innerHTML = `<div class="avatar">ğŸ¤–</div><div class="chat-bubble">${preserveWhitespace(text)}</div>`;
    chatBox.appendChild(msg);
    scrollToBottom();
  }

  // íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜ ì¶”ê°€!
  async function handleFileUpload(event) {
    event.preventDefault();
    const fileInput = document.getElementById('file-input');
    const statusElem = document.getElementById('upload-status');
    if (!fileInput.files || fileInput.files.length === 0) {
      statusElem.textContent = "íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.";
      return;
    }

    const file = fileInput.files[0];
    statusElem.textContent = "ì—…ë¡œë“œ ì¤‘...";

    const formData = new FormData();
    formData.append('file', file);

    try {
      const res = await fetch('https://knu-chatbot-backend.onrender.com/upload', {
        method: 'POST',
        body: formData,
      });
      if (!res.ok) throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
      const data = await res.json();
      // ë°±ì—”ë“œì—ì„œ ë°˜í™˜í•˜ëŠ” ì„¸ì…˜IDë¥¼ ì €ì¥ (ì˜ˆì‹œ: {session_id: "..."} )
      fileSessionId = data.session_id || sessionId;
      statusElem.textContent = "ì—…ë¡œë“œ ì„±ê³µ! ì´ì œ ì´ íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ì§ˆë¬¸í•´ë³´ì„¸ìš”.";
      appendBotMessage("âœ… íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì§ˆë¬¸ì„ ì…ë ¥í•˜ì‹œë©´ íŒŒì¼ ë‚´ìš©ë„ í•¨ê»˜ ë¶„ì„í•©ë‹ˆë‹¤.");
    } catch (e) {
      statusElem.textContent = "ì—…ë¡œë“œ ì‹¤íŒ¨";
      appendBotMessage("âš ï¸ íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆì–´ìš”.");
    }
  }

  // sendMessageì— fileSessionId ë°˜ì˜ (íŒŒì¼ ì—…ë¡œë“œ ì‹œ ì„¸ì…˜ID ìš°ì„ )
  async function sendMessage(customInput) {
    const inputElem = document.getElementById("user-input");
    const input = customInput || inputElem.value.trim();
    if (input === "") return;

    appendUserMessage(input);
    if (!customInput) inputElem.value = "";

    showLoading();

    try {
      const chatBox = document.getElementById("chat-box");
      loadingMessage = document.createElement("div");
      loadingMessage.className = "chat-message bot";
      loadingMessage.innerHTML = `
        <div class="avatar">ğŸ¤–</div>
        <div class="chat-bubble"><span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></div>
        <span class="cancel-x" title="ì·¨ì†Œí•˜ê¸°" onclick="cancelRequest()">â</span>
      `;
      chatBox.appendChild(loadingMessage);
      scrollToBottom();

      loadingTimer = setTimeout(() => { cancelRequest(); }, 30000);

      controller = new AbortController();

      // session_idë¥¼ í•­ìƒ íŒŒì¼ ì—…ë¡œë“œ í›„ ë°›ì€ ê²ƒìœ¼ë¡œ ìš°ì„  ì ìš©!
      const sendSessionId = fileSessionId || sessionId;

      const response = await fetch("https://knu-chatbot-backend.onrender.com/stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: sendSessionId, question: input }),
        signal: controller.signal
      });

      const reader = response.body.getReader();
      streamReader = reader;
      const decoder = new TextDecoder("utf-8");
      let buffer = "";
      let isFirst = true;
      let chatBubble = null;
      let currentText = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        let parts = buffer.split("\n");
        buffer = parts.pop();
        for (const part of parts) {
          if (part.startsWith("data:")) {
            const data = part.replace(/^data:\s*/, "");
            if (isFirst && loadingMessage && loadingMessage.parentNode) {
              const bubble = loadingMessage.querySelector(".chat-bubble");
              bubble.innerHTML = "";
              chatBubble = bubble;
              isFirst = false;
              currentText = "";
            }
            if (chatBubble) {
              currentText += data;
              chatBubble.innerHTML = preserveWhitespace(currentText);
              scrollToBottom();
            }
          }
        }
      }

      clearTimeout(loadingTimer);

      if (loadingMessage) {
        const cancelBtn = loadingMessage.querySelector('.cancel-x');
        if (cancelBtn) cancelBtn.remove();
        loadingMessage = null;
      }
    } catch (error) {
      clearTimeout(loadingTimer);
      if (loadingMessage && loadingMessage.parentNode) {
        loadingMessage.parentNode.removeChild(loadingMessage);
        loadingMessage = null;
        appendBotMessage("âš ï¸ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆì–´ìš”.");
      }
    }

    streamReader = null;
    hideLoading();
  }

  function sendRecommendedQuestion(text) {
    sendMessage(text);
  }
</script>
</body>
</html>
