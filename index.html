<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>경북대학교 전기공학과 챗봇</title>
  <style>
    /* ... 기존 스타일 그대로 ... */
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-title">
        <img alt="KNU 로고" class="logo" src="knu_logo.jpg"/>
        <h1>경북대학교 전기공학과 챗봇</h1>
      </div>
      <button id="reset-btn" title="채팅 초기화">🗑️</button>
    </div>
  </header>
  <div class="recommend-box">
    <button class="recommend-btn" onclick="sendRecommendedQuestion('졸업 요건이 어떻게 되나요?')">🎓 졸업 요건</button>
    <button class="recommend-btn" onclick="sendRecommendedQuestion('교수님 이메일은 어디서 확인해요?')">📬 교수님 이메일</button>
  </div>
  <div class="container">
    <div id="chat-box"></div>
  </div>
  <!-- 파일 업로드 UI 추가 -->
  <div class="input-area" style="flex-direction: column; align-items: stretch;">
    <form id="upload-form" style="margin-bottom: 8px; display:flex; gap:8px;">
      <input type="file" id="file-input" accept=".pdf,.jpg,.jpeg,.png" />
      <button type="submit" id="upload-btn">파일 업로드</button>
      <span id="upload-status" style="margin-left:10px; color:#3366ff;"></span>
    </form>
    <div class="input-area-inner">
      <textarea id="user-input" placeholder="메시지를 입력하세요 (Shift+Enter 줄바꿈)" rows="1"></textarea>
      <button id="send-btn" onclick="sendMessage()">➤</button>
    </div>
  </div>
<script>
  // sessionId(챗 세션)와 fileSessionId(파일 세션) 분리
  const sessionId = crypto.randomUUID();
  let fileSessionId = null; // 파일 업로드 성공 시 반환되는 세션ID

  // 기존 변수 및 함수들 그대로...
  let controller = null;
  let loadingMessage = null;
  let loadingTimer = null;
  let streamReader = null;

  function preserveWhitespace(text) {
    // ... (생략, 기존 함수 그대로)
    text = text.replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
    text = text.replace(/(https?:\/\/[^\s<>(){}\[\]'"]+[\w/#?&=~%@-])/g, function(url) {
      return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });
    text = text.replace(/ {2,}/g, function(space) {
      return "&nbsp;".repeat(space.length);
    });
    text = text.replace(/\n/g, "<br>");
    return text;
  }

  function scrollToBottom() {
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  function cancelRequest() {
    // ... (생략, 기존 함수 그대로)
    if (!loadingMessage) return;
    if (controller) controller.abort();
    if (streamReader) streamReader.cancel();
    if (loadingMessage && loadingMessage.parentNode) {
      loadingMessage.parentNode.removeChild(loadingMessage);
      loadingMessage = null;
    }
    appendBotMessage("⚠️ 서버 연결에 실패했어요.");
    hideLoading();
    scrollToBottom();
    clearTimeout(loadingTimer);
  }

  window.onload = function () {
    initChat();
    const inputElem = document.getElementById("user-input");
    inputElem.addEventListener("keydown", function (event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });
    document.getElementById("reset-btn").addEventListener("click", () => {
      initChat();
    });

    // 파일 업로드 폼 이벤트 추가!
    document.getElementById('upload-form').addEventListener('submit', handleFileUpload);
  };

  function initChat() {
    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML = "";
    const intro = document.createElement("div");
    intro.className = "chat-message bot";
    intro.innerHTML = `
      <div class="avatar">🤖</div>
      <div class="chat-bubble bot-intro">⚡ 무엇이든 물어보세요! 경북대학교 전기공학과 챗봇입니다.<br><span style="font-weight:normal;color:#0066bb">PDF/이미지 파일도 업로드하여 질문할 수 있습니다.</span></div>
    `;
    chatBox.appendChild(intro);
    scrollToBottom();
    // 파일 세션도 리셋!
    fileSessionId = null;
    document.getElementById("upload-status").textContent = "";
    document.getElementById("file-input").value = "";
  }

  function showLoading() {
    document.getElementById("user-input").disabled = true;
    document.getElementById("send-btn").disabled = true;
  }
  function hideLoading() {
    document.getElementById("user-input").disabled = false;
    document.getElementById("send-btn").disabled = false;
  }

  function appendUserMessage(text) {
    const chatBox = document.getElementById("chat-box");
    const msg = document.createElement("div");
    msg.className = "chat-message user";
    msg.innerHTML = `<div class="avatar">🙋‍♂️</div><div class="chat-bubble">${preserveWhitespace(text)}</div>`;
    chatBox.appendChild(msg);
    scrollToBottom();
  }

  function appendBotMessage(text) {
    const chatBox = document.getElementById("chat-box");
    const msg = document.createElement("div");
    msg.className = "chat-message bot";
    msg.innerHTML = `<div class="avatar">🤖</div><div class="chat-bubble">${preserveWhitespace(text)}</div>`;
    chatBox.appendChild(msg);
    scrollToBottom();
  }

  // 파일 업로드 함수 추가!
  async function handleFileUpload(event) {
    event.preventDefault();
    const fileInput = document.getElementById('file-input');
    const statusElem = document.getElementById('upload-status');
    if (!fileInput.files || fileInput.files.length === 0) {
      statusElem.textContent = "파일을 선택하세요.";
      return;
    }

    const file = fileInput.files[0];
    statusElem.textContent = "업로드 중...";

    const formData = new FormData();
    formData.append('file', file);

    try {
      const res = await fetch('https://knu-chatbot-backend.onrender.com/upload', {
        method: 'POST',
        body: formData,
      });
      if (!res.ok) throw new Error('업로드 실패');
      const data = await res.json();
      // 백엔드에서 반환하는 세션ID를 저장 (예시: {session_id: "..."} )
      fileSessionId = data.session_id || sessionId;
      statusElem.textContent = "업로드 성공! 이제 이 파일을 기반으로 질문해보세요.";
      appendBotMessage("✅ 파일이 성공적으로 업로드되었습니다. 질문을 입력하시면 파일 내용도 함께 분석합니다.");
    } catch (e) {
      statusElem.textContent = "업로드 실패";
      appendBotMessage("⚠️ 파일 업로드에 실패했어요.");
    }
  }

  // sendMessage에 fileSessionId 반영 (파일 업로드 시 세션ID 우선)
  async function sendMessage(customInput) {
    const inputElem = document.getElementById("user-input");
    const input = customInput || inputElem.value.trim();
    if (input === "") return;

    appendUserMessage(input);
    if (!customInput) inputElem.value = "";

    showLoading();

    try {
      const chatBox = document.getElementById("chat-box");
      loadingMessage = document.createElement("div");
      loadingMessage.className = "chat-message bot";
      loadingMessage.innerHTML = `
        <div class="avatar">🤖</div>
        <div class="chat-bubble"><span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></div>
        <span class="cancel-x" title="취소하기" onclick="cancelRequest()">❎</span>
      `;
      chatBox.appendChild(loadingMessage);
      scrollToBottom();

      loadingTimer = setTimeout(() => { cancelRequest(); }, 30000);

      controller = new AbortController();

      // session_id를 항상 파일 업로드 후 받은 것으로 우선 적용!
      const sendSessionId = fileSessionId || sessionId;

      const response = await fetch("https://knu-chatbot-backend.onrender.com/stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: sendSessionId, question: input }),
        signal: controller.signal
      });

      const reader = response.body.getReader();
      streamReader = reader;
      const decoder = new TextDecoder("utf-8");
      let buffer = "";
      let isFirst = true;
      let chatBubble = null;
      let currentText = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        let parts = buffer.split("\n");
        buffer = parts.pop();
        for (const part of parts) {
          if (part.startsWith("data:")) {
            const data = part.replace(/^data:\s*/, "");
            if (isFirst && loadingMessage && loadingMessage.parentNode) {
              const bubble = loadingMessage.querySelector(".chat-bubble");
              bubble.innerHTML = "";
              chatBubble = bubble;
              isFirst = false;
              currentText = "";
            }
            if (chatBubble) {
              currentText += data;
              chatBubble.innerHTML = preserveWhitespace(currentText);
              scrollToBottom();
            }
          }
        }
      }

      clearTimeout(loadingTimer);

      if (loadingMessage) {
        const cancelBtn = loadingMessage.querySelector('.cancel-x');
        if (cancelBtn) cancelBtn.remove();
        loadingMessage = null;
      }
    } catch (error) {
      clearTimeout(loadingTimer);
      if (loadingMessage && loadingMessage.parentNode) {
        loadingMessage.parentNode.removeChild(loadingMessage);
        loadingMessage = null;
        appendBotMessage("⚠️ 서버 연결에 실패했어요.");
      }
    }

    streamReader = null;
    hideLoading();
  }

  function sendRecommendedQuestion(text) {
    sendMessage(text);
  }
</script>
</body>
</html>
