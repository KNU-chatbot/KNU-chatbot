<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Í≤ΩÎ∂ÅÎåÄÌïôÍµê Ï†ÑÍ∏∞Í≥µÌïôÍ≥º Ï±óÎ¥á</title>
  <style>
    html, body { margin: 0; padding: 0; background: #fff; min-height: 100dvh; height: 100dvh; font-family: "Segoe UI", "ÎÇòÎàîÍ≥†Îîï", sans-serif; }
    body { min-height: 100dvh; height: 100dvh; display: flex; flex-direction: column; }
    header { position: fixed; top: 0; left: 0; width: 100%; z-index: 10; background: #fff; padding: 20px 0 10px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: center; box-sizing: border-box; }
    .header-inner { width: 100%; max-width: 850px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; box-sizing: border-box; }
    .header-title { display: flex; align-items: center; gap: 8px; }
    h1 { font-size: 20px; color: #222; margin: 0; display: inline-block; }
    .logo { width: 40px; margin-right: 12px; }
    #id-badge { color:#666; font-size:12px; }
    #reset-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #888; }
    #reset-btn:hover { color: #222; }
    .container {
      max-width: 850px;
      margin: 0 auto;
      width: 100%;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      position: relative;
      padding-top: 70px;
      padding-bottom: 88px;
      box-sizing: border-box;
    }
    #chat-box {
      flex: 1 1 auto;
      overflow-x: hidden;
      min-height: 0;
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chat-message { display: flex; max-width: 100%; }
    .chat-message.user {
      width: 100%;
      justify-content: flex-end;
      flex-direction: row-reverse;
      align-items: flex-end;
    }
    .chat-message.bot {
      justify-content: flex-start;
      flex-direction: row;
      align-items: flex-start;
    }
    .chat-message.bot .avatar { margin-right: 8px; margin-left: 0; align-self: flex-start; }
    .chat-message.user .avatar { margin-left: 8px; margin-right: 0; align-self: flex-end; }
    .avatar { font-size: 22px; user-select: none; }
    .chat-bubble {
      background: #f2f2f2;
      border-radius: 12px;
      padding: 12px 18px 28px 18px;
      display: inline-block;
      max-width: 70%;
      min-width: 60px;
      word-break: break-word;
      font-size: 15px;
      line-height: 1.6;
      color: #222;
      position: relative;
      vertical-align: top;
      box-sizing: border-box;
    }
    .chat-bubble.error { padding-bottom: 12px !important; }
    .chat-message.user .chat-bubble { background: #e1f0ff; margin-left: auto; margin-right: 0; text-align: left; max-width: 70%; }
    .bot-intro { background-color: #e0e0e0 !important; font-weight: bold; padding: 10px 12px 10px 10px !important; max-width: 48% !important; width: 100% !important; display: block !important; box-sizing: border-box; }

    .bubble-action-user {
      position: absolute; bottom: 5px; right: 10px; margin-top: 8px; display: flex; gap: 4px;
    }
    .bubble-action-bot {
      position: absolute; bottom: 5px; left: 10px; margin-top: 8px; display: flex; gap: 4px;
    }
    .action-btn { background: none; border: none; cursor: pointer; font-size: 15px; padding: 2px; border-radius: 50%; transition: background 0.13s; line-height: 1; margin: 0 0 0 2px; vertical-align: middle; }
    .action-btn:hover { background: #eaeaea; }

    .input-area {
      position: fixed; left: 0; bottom: 0; width: 100%; z-index: 11; border-top: 1px solid #eee; background: #fff; padding: 16px 0; display: flex; justify-content: center; align-items: center;
    }
    .input-area-inner { width: 100%; max-width: 850px; display: flex; align-items: center; }
    .file-upload-btn {
      border: none; background: #e1f0ff; border-radius: 8px; padding: 0; font-size: 15px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; transition: background 0.18s; margin-right: 5px;
    }
    .file-upload-btn:hover { background: #b7d6fa; }
    .file-icon {
      display: inline-block; width: 22px; height: 22px; background: none;
      mask: url('data:image/svg+xml;utf8,<svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7.757 16.243a4 4 0 0 1 0-5.657l5.657-5.657a4 4 0 0 1 5.657 5.657l-7.07 7.071a2 2 0 1 1-2.829-2.829l7.07-7.071" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>') center / contain no-repeat;
      -webkit-mask: url('data:image/svg+xml;utf8,<svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7.757 16.243a4 4 0 0 1 0-5.657l5.657-5.657a4 4 0 0 1 5.657 5.657l-7.07 7.071a2 2 0 1 1-2.829-2.829l7.07-7.071" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>') center / contain no-repeat;
      background-color: #1a4fa4;
    }
    #file-upload { display:none; }
    #file-name-display { font-size: 13px; color: #888; margin-right: 6px; }
    #user-input {
      flex: 1; border: 1px solid #ccc; border-radius: 8px; font-size: 15px;
      padding: 12px; resize: none; margin-right: 10px; min-width: 0;
    }
    #send-btn { background: #111; color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-size: 15px; cursor: pointer; }
    #send-btn:hover { background: #444; }
    .cancel-x { color: red; margin-left: 8px; cursor: pointer; font-weight: bold; user-select: none; font-size: 18px; align-self: center; }
    .cancel-x:hover { color: darkred; }
    .loading-dots { display: inline-block; white-space: nowrap; vertical-align: middle; }
    .loading-dots span { display: inline-block; font-size: 22px; line-height: 1; animation: bounceDot 1s infinite; }
    .loading-dots span:nth-child(1) { animation-delay: 0s; }
    .loading-dots span:nth-child(2) { animation-delay: 0.15s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.3s; }
    @keyframes bounceDot { 0%, 80%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } 50% { transform: translateY(0); } }

    .recommend-box { position: fixed; top: 120px; left: calc(50% + 425px + 32px); display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
    .recommend-btn { background-color: #f7f7f7; color: #111; border: 1px solid #ccc; border-radius: 6px; padding: 8px 12px; font-size: 14px; cursor: pointer; text-align: left; }
    .recommend-btn:hover { background-color: #eee; }
    @media (max-width: 900px) {
      .container { max-width: 100vw; }
      .recommend-box { display: none; }
      header, .header-inner { max-width: 100vw !important; }
    }
    textarea:disabled, button:disabled { opacity: 0.5; cursor: not-allowed; }

    #voice-btn { border-radius: 50%; transition: background 0.18s, border 0.18s; }
    #voice-btn[aria-pressed="true"] {
      background: #f75c44 !important; border: 2px solid #f75c44; animation: mic-pulse 1s infinite;
    }
    #voice-btn[aria-pressed="true"] svg rect, #voice-btn[aria-pressed="true"] svg path { stroke: #fff !important; transition: stroke 0.1s; }
    #voice-btn svg rect, #voice-btn svg path { stroke: #111; stroke-width: 2; transition: stroke 0.1s; }
    @keyframes mic-pulse { 0% { box-shadow: 0 0 0 0 #f75c4477; } 70% { box-shadow: 0 0 0 10px #f75c4400; } 100% { box-shadow: 0 0 0 0 #f75c4400; }
    }

    .chat-bubble.loading {
      display: flex !important; justify-content: center !important; align-items: center !important;
      min-width: 60px; min-height: 40px; padding: 12px 18px !important; background: #f2f2f2;
    }

    /* ÏÑ∏ÏÖò Î™©Î°ù ÏÇ¨Ïù¥ÎìúÎ∞î */
    #session-list {
      position: fixed; top: 120px; left: calc(50% - 425px - 252px);
      width: 220px; max-height: 70vh; overflow:auto; border:1px solid #eee; border-radius:8px; padding:8px; background:#fff; display:none; z-index: 9;
    }
    #session-items { display:flex; flex-direction:column; gap:6px; }
    .session-item { text-align:left; border:1px solid #ddd; background:#f7f7f7; border-radius:6px; padding:6px; cursor:pointer; }
    .session-item:hover { background:#eee; }
    @media (max-width: 1200px) { #session-list { display:none !important; } }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-title">
        <img alt="KNU Î°úÍ≥†" class="logo" src="knu_logo.jpg"/>
        <h1>Í≤ΩÎ∂ÅÎåÄÌïôÍµê Ï†ÑÍ∏∞Í≥µÌïôÍ≥º Ï±óÎ¥á</h1>
        <small id="id-badge"></small>
      </div>
      <button id="reset-btn" title="Ï±ÑÌåÖ Ï¥àÍ∏∞Ìôî">üóëÔ∏è</button>
    </div>
  </header>

  <!-- ÏÑ∏ÏÖò Î™©Î°ù(ÏµúÍ∑º 5Í∞ú) -->
  <div id="session-list">
    <div style="font-weight:600; margin-bottom:6px;">ÏµúÍ∑º ÎåÄÌôî</div>
    <div id="session-items"></div>
  </div>

  <div class="recommend-box">
    <button class="recommend-btn" onclick="sendRecommendedQuestion('Ï°∏ÏóÖ ÏöîÍ±¥Ïù¥ Ïñ¥ÎñªÍ≤å ÎêòÎÇòÏöî?')">üéì Ï°∏ÏóÖ ÏöîÍ±¥</button>
    <button class="recommend-btn" onclick="sendRecommendedQuestion('ÍµêÏàòÎãò Ïù¥Î©îÏùºÏùÄ Ïñ¥ÎîîÏÑú ÌôïÏù∏Ìï¥Ïöî?')">üì¨ ÍµêÏàòÎãò Ïù¥Î©îÏùº</button>
    <button class="recommend-btn" onclick="sendRecommendedQuestion('ÍµêÍ≥º Í≥ºÏ†ïÏù¥ Ïñ¥ÎñªÍ≤å ÎêòÎÇòÏöî?')">üìñ ÍµêÍ≥º Í≥ºÏ†ï</button>
    <button class="recommend-btn" onclick="sendRecommendedQuestion('Í≥µÏßÄÏÇ¨Ìï≠ÏùÄ Ïñ¥ÎîîÏÑú ÌôïÏù∏Ìï¥Ïöî?')">üì¢ Í≥µÏßÄÏÇ¨Ìï≠</button>
  </div>

  <div class="container">
    <div id="chat-box"></div>
  </div>

  <div class="input-area">
    <div class="input-area-inner">
      <label for="file-upload" class="file-upload-btn" title="ÌååÏùº ÏóÖÎ°úÎìú">
        <span class="file-icon"></span>
      </label>
      <input type="file" id="file-upload" accept=".pdf,.jpg,.jpeg,.png" />
      <span id="file-name-display"></span>
      <textarea id="user-input" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Shift+Enter Ï§ÑÎ∞îÍøà)" rows="1"></textarea>
      <button id="voice-btn" title="ÏùåÏÑ± ÏûÖÎ†•" style="background: none; border: none; width:40px; height:40px; margin-right:6px; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:50%;">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
          <rect x="9" y="2" width="6" height="12" rx="3"/>
          <path d="M5 10v2a7 7 0 0 0 14 0v-2"/>
          <path d="M12 19v3"/>
          <path d="M8 22h8"/>
        </svg>
      </button>
      <button id="send-btn" onclick="sendMessage()">‚û§</button>
    </div>
  </div>

<script>
  // ====== ÌôòÍ≤Ω ======
  const BACKEND_URL = "https://knu-chatbot-backend-docker.onrender.com";

  // ====== user_id ÏòÅÍµ¨ Î≥¥Í¥Ä Î∞è ÏÑ∏ÏÖò Í¥ÄÎ¶¨ ======
  const storedUserId = localStorage.getItem('knu_user_id');
  const userId = storedUserId || crypto.randomUUID();
  if (!storedUserId) localStorage.setItem('knu_user_id', userId);

  let sessionId = crypto.randomUUID();

  // ====== FRONTEND-ONLY HISTORY HELPERS ======
  function lsGet(key, fallback) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; } }
  function lsSet(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch(e) { console.warn('[history] lsSet error', e); } }
  function sessionListKey(uid) { return `knu_sessions_${uid}`; }
  function chatKey(sid) { return `knu_chat_${sid}`; }
  function deletedSessionsKey(uid) { return `knu_deleted_sessions_${uid}`; }
  function getDeletedSet() { return new Set(lsGet(deletedSessionsKey(userId), [])); }
  function addDeleted(sid) {
    const set = getDeletedSet();
    if (!set.has(sid)) {
      const arr = Array.from(set);
      arr.push(sid);
      lsSet(deletedSessionsKey(userId), arr);
    }
  }
  function ensureSessionListed(uid, sid, titleText) {
    const key = sessionListKey(uid);
    const list = lsGet(key, []);
    const idx = list.findIndex(x => x.sessionId === sid);
    const title = (titleText || '').slice(0, 50) || sid.slice(0, 8);
    if (idx >= 0) { list[idx].updatedAt = Date.now(); if (titleText) list[idx].title = title; }
    else { list.unshift({ sessionId: sid, title, createdAt: Date.now(), updatedAt: Date.now() }); }
    lsSet(key, list.slice(0, 20));
  }
  function appendToChatStore(sid, role, text) {
    const key = chatKey(sid);
    const arr = lsGet(key, []);
    arr.push({ role, text, ts: Date.now() });
    lsSet(key, arr);
  }
  let controller = null;
  let loadingMessage = null;
  let loadingTimer = null;
  let streamReader = null;
  let lastUploadedFileName = "";

  function updateIdBadge() {
    const el = document.getElementById('id-badge');
    if (!el) return;
    el.textContent = `user:${userId.slice(0,8)} ¬∑ session:${sessionId.slice(0,8)}`;
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => { alert('Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!'); });
  }
  function speakText(text) {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text.replace(/<br>/g, "\n").replace(/<[^>]+>/g, ""));
      utter.lang = "ko-KR";
      window.speechSynthesis.speak(utter);
    } else {
      alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî ÏùåÏÑ± ÏùΩÍ∏∞Í∞Ä ÏßÄÏõêÎêòÏßÄ ÏïäÏäµÎãàÎã§.');
    }
  }

  function removeMessagesAfter(msgId) {
    const chatBox = document.getElementById("chat-box");
    let found = false;
    const toRemove = [];
    Array.from(chatBox.children).forEach(child => {
      if (found || child.id === msgId) toRemove.push(child);
      if (child.id === msgId && !found) found = true;
    });
    toRemove.forEach(node => chatBox.removeChild(node));
  }
  function regenerateResponse(botMsgId, originalQuestion) {
    removeMessagesAfter(botMsgId);
    sendMessage(originalQuestion, true);
  }
  function editUserMessage(userMsgId, text) {
    removeMessagesAfter(userMsgId);
    const inputElem = document.getElementById("user-input");
    inputElem.value = text.replace(/<br>/g, "\n").replace(/<[^>]+>/g, "");
    inputElem.focus();
  }

  function preserveWhitespace(text) {
    text = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    text = text.replace(/((https?:\/\/|www\.)[^\s<>(){}\[\]'\"]+[\w/#?&=~%@-])/g, function(url) {
      let href = url; if (url.startsWith("www.")) { href = "http://" + url; }
      return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });
    text = text.replace(/ {2,}/g, function(space) { return "&nbsp;".repeat(space.length); });
    text = text.replace(/\n/g, "<br>");
    return text;
  }

  function scrollToBottom() {
    const chatBox = document.getElementById("chat-box");
    chatBox.scrollTop = chatBox.scrollHeight;
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  function cancelRequest() {
    if (!loadingMessage) return;
    if (controller) controller.abort();
    if (streamReader) streamReader.cancel();
    if (loadingMessage && loadingMessage.parentNode) {
      loadingMessage.parentNode.removeChild(loadingMessage);
      loadingMessage = null;
    }
    appendBotMessage("‚ö†Ô∏è ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî.");
    hideLoading();
    scrollToBottom();
    clearTimeout(loadingTimer);
  }

  window.onload = function () {
    initChat();
    updateIdBadge();
    fetchSessions();

    const inputElem = document.getElementById("user-input");
    inputElem.addEventListener("keydown", function (event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });
    document.getElementById("reset-btn").addEventListener("click", () => {
      sessionId = crypto.randomUUID(); // ÏÉà ÎåÄÌôî
      initChat();
      updateIdBadge();
      fetchSessions();
    });
    document.getElementById("file-upload").addEventListener("change", handleFileUpload);
  };

  function initChat() {
    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML = "";
    const intro = document.createElement("div");
    intro.className = "chat-message bot";
    intro.innerHTML = `
      <div class="avatar">ü§ñ</div>
      <div class="chat-bubble bot-intro">‚ö° Î¨¥ÏóáÏù¥Îì† Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî! Í≤ΩÎ∂ÅÎåÄÌïôÍµê Ï†ÑÍ∏∞Í≥µÌïôÍ≥º Ï±óÎ¥áÏûÖÎãàÎã§.</div>
    `;
    chatBox.appendChild(intro);
    scrollToBottom();
    lastUploadedFileName = "";
    document.getElementById("file-name-display").textContent = "";
  }

  function showLoading() {
    document.getElementById("user-input").disabled = true;
    document.getElementById("send-btn").disabled = true;
    document.getElementById("file-upload").disabled = true;
    document.querySelector(".file-upload-btn").style.opacity = "0.5";
    document.getElementById("voice-btn").disabled = true;
  }
  function hideLoading() {
    document.getElementById("user-input").disabled = false;
    document.getElementById("send-btn").disabled = false;
    document.getElementById("file-upload").disabled = false;
    document.querySelector(".file-upload-btn").style.opacity = "1";
    document.getElementById("voice-btn").disabled = false;
  }

  let userMessageSeq = 0;
  let botMessageSeq = 0;

  function appendUserMessage(text) {
    const chatBox = document.getElementById("chat-box");
    const msgId = `user-msg-${++userMessageSeq}`;
    const msg = document.createElement("div");
    msg.className = "chat-message user";
    msg.id = msgId;
    msg.innerHTML = `
      <div class="avatar">üôã‚Äç‚ôÇÔ∏è</div>
      <div class="chat-bubble">
        ${preserveWhitespace(text)}
        <div class="bubble-action-user">
          <button class="action-btn" title="Î©îÏãúÏßÄ Ìé∏Ïßë" onclick="editUserMessage('${msgId}', '${text.replace(/'/g, "\\'").replace(/\n/g, "\\n").replace(/<[^>]+>/g, "")}')">‚úèÔ∏è</button>
        </div>
      </div>
    `;
    chatBox.appendChild(msg);
    scrollToBottom();
    appendToChatStore(sessionId, 'user', text);
    ensureSessionListed(userId, sessionId, text);
    return msgId;
  }

  function appendBotMessage(text, originalQuestion) {
    const chatBox = document.getElementById("chat-box");
    const msgId = `bot-msg-${++botMessageSeq}`;
    const isError = (
      text.includes("ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî") ||
      text.includes("ÌååÏùº ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏñ¥Ïöî") ||
      text.includes("Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî")
    );
    const msg = document.createElement("div");
    msg.className = "chat-message bot";
    msg.id = msgId;
    msg.innerHTML = `
      <div class="avatar">ü§ñ</div>
      <div class="chat-bubble${isError ? " error" : ""}">
        ${preserveWhitespace(text)}
        ${!isError ? `
          <div class="bubble-action-bot">
            <button class="action-btn" title="Î≥µÏÇ¨" onclick="copyToClipboard('${text.replace(/'/g, "\\'").replace(/\n/g, "\\n").replace(/<br>/g, "\\n").replace(/<[^>]+>/g, "")}')">üìã</button>
            <button class="action-btn" title="ÏùåÏÑ± ÏùΩÍ∏∞" onclick="speakText('${text.replace(/'/g, "\\'").replace(/\n/g, "\\n").replace(/<br>/g, "\\n").replace(/<[^>]+>/g, "")}')">üîä</button>
            <button class="action-btn" title="ÏùëÎãµ Ïû¨ÏÉùÏÑ±" onclick="regenerateResponse('${msgId}', '${originalQuestion ? originalQuestion.replace(/'/g, "\\'") : ''}')">üîÑ</button>
          </div>
        ` : ""}
      </div>
    `;
    chatBox.appendChild(msg);
    scrollToBottom();
    appendToChatStore(sessionId, 'bot', text);
    ensureSessionListed(userId, sessionId, (originalQuestion || text));
    return msgId;
  }

  // ====== ÌååÏùº ÏóÖÎ°úÎìú ======
  async function handleFileUpload(event) {
    const fileInput = event.target;
    const file = fileInput.files[0];
    if (!file) return;

    const allowedTypes = ['application/pdf', 'image/jpg', 'image/jpeg', 'image/png'];
    if (!allowedTypes.includes(file.type)) {
      alert('PDF, JPG, JPEG, PNG ÌååÏùºÎßå ÏóÖÎ°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§.');
      fileInput.value = "";
      return;
    }

    showLoading();
    try {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("session_id", sessionId);

      const response = await fetch(`${BACKEND_URL}/upload`, { method: "POST", body: formData });
      if (!response.ok) throw new Error("ÌååÏùº ÏóÖÎ°úÎìú Ïã§Ìå®!");

      const result = await response.json();
      lastUploadedFileName = file.name;
      document.getElementById("file-name-display").textContent = `ÏóÖÎ°úÎìú: ${file.name}`;
      appendBotMessage(`‚úÖ <${file.name}> ÌååÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`);
    } catch (error) {
      document.getElementById("file-name-display").textContent = "";
      appendBotMessage("‚ö†Ô∏è ÌååÏùº ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏñ¥Ïöî. Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.");
    }
    hideLoading();
    fileInput.value = "";
  }

  // ====== ÌûàÏä§ÌÜ†Î¶¨ Î†åÎçîÎßÅ ======
  function clearChatExceptIntro() {
    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML = "";
    const intro = document.createElement("div");
    intro.className = "chat-message bot";
    intro.innerHTML = `
      <div class="avatar">ü§ñ</div>
      <div class="chat-bubble bot-intro">üóÇÔ∏è ÏÑ†ÌÉùÌïú ÎåÄÌôîÏùò Í∏∞Î°ùÏùÑ Î∂àÎü¨ÏôîÏñ¥Ïöî.</div>
    `;
    chatBox.appendChild(intro);
  }

  function renderHistory(historyArray) {
    clearChatExceptIntro();
    if (!Array.isArray(historyArray) || historyArray.length === 0) {
      appendBotMessage("Ïù¥ ÏÑ∏ÏÖòÏóêÎäî ÌëúÏãúÌï† ÎåÄÌôîÍ∞Ä ÏóÜÏñ¥Ïöî. ÏÉàÎ°ú ÏßàÎ¨∏Ìï¥ Ï£ºÏÑ∏Ïöî.");
      return;
    }
    historyArray.forEach(item => {
      const q = (item.question ?? "").toString();
      const a = (item.answer ?? "").toString();
      if (q) appendUserMessage(q);
      if (a) appendBotMessage(a, q);
    });
  }

  async function fetchHistory(targetSessionId) {
    try {
      const res = await fetch(`${BACKEND_URL}/history/${targetSessionId}`);
      if (!res.ok) throw new Error();
      const data = await res.json();
      renderHistory(data.history || []);
    } catch (e) {
      // FRONTEND-ONLY FALLBACK
      const sid = targetSessionId || sessionId;
      const arr = lsGet(chatKey(sid), []);
      clearChatExceptIntro();
      if (!arr.length) {
        appendBotMessage("Ïù¥ ÏÑ∏ÏÖòÏóêÎäî ÌëúÏãúÌï† ÎåÄÌôîÍ∞Ä ÏóÜÏñ¥Ïöî. ÏÉàÎ°ú ÏßàÎ¨∏Ìï¥ Ï£ºÏÑ∏Ïöî.");
        return;
      }
      arr.forEach(item => {
        if (item.role === 'user') appendUserMessage(item.text);
        else appendBotMessage(item.text);
      });
    }
  }

  // ====== ÏÑ∏ÏÖò ÏÇ≠Ï†ú ======
  function deleteSession(targetSessionId) {
    try {
      // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÏÑ∏ÏÖò Î©îÌÉÄ/ÎåÄÌôî ÏÇ≠Ï†ú
      const list = lsGet(sessionListKey(userId), []).filter(s => s.sessionId !== targetSessionId);
      lsSet(sessionListKey(userId), list);
      localStorage.removeItem(chatKey(targetSessionId));

      // UI Ï¶âÏãú Î∞òÏòÅ: ÏÑ∏ÏÖò Î¶¨Ïä§Ìä∏ÏóêÏÑú Ìï¥Îãπ Ìñâ Ï†úÍ±∞
      const items = document.getElementById('session-items');
      if (items) {
        Array.from(items.children).forEach(row => {
          const btn = row.querySelector('button');
          if (btn && btn.title === targetSessionId) items.removeChild(row);
        });
      }

      // ÏÇ≠Ï†ú Î™©Î°ùÏóê Í∏∞Î°ùÌïòÏó¨ Î∞±ÏóîÎìú ÏùëÎãµÍ≥º Î¨¥Í¥ÄÌïòÍ≤å ÌôîÎ©¥ÏóêÏÑú Ïà®ÍπÄ
      addDeleted(targetSessionId);

      // ÌòÑÏû¨ Î≥¥Í≥† ÏûàÎçò ÏÑ∏ÏÖòÏùÑ ÏßÄÏõ†Îã§Î©¥ ÏÉà ÏÑ∏ÏÖò ÏãúÏûë
      if (sessionId === targetSessionId) {
        sessionId = crypto.randomUUID();
        initChat();
        updateIdBadge();
      }

      // (ÏÑ†ÌÉù) Î∞±ÏóîÎìúÏóêÎèÑ ÏÇ≠Ï†ú ÏöîÏ≤≠ (ÏóîÎìúÌè¨Ïù∏Ìä∏ Ï°¥Ïû¨ Ïãú)
      fetch(`${BACKEND_URL}/delete_session/${targetSessionId}`, { method: 'DELETE' }).catch(() => {});

      // Î™©Î°ù Ïû¨Î°úÎî© (ÌïÑÌÑ∞Í∞Ä Ï†ÅÏö©ÎêòÏñ¥ Ïù¥ÎØ∏ ÏÇ≠Ï†úÎêú Ìï≠Î™©ÏùÄ ÌëúÏãúÎêòÏßÄ ÏïäÏùå)
      fetchSessions();
    } catch (e) {
      console.warn('ÏÑ∏ÏÖò ÏÇ≠Ï†ú Ïò§Î•ò:', e);
    }
  }

  // ====== ÏµúÍ∑º ÏÑ∏ÏÖò Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞ & Ï†ÑÌôò ======
  async function fetchSessions() {
    try {
      const res = await fetch(`${BACKEND_URL}/sessions/${userId}`);
      if (!res.ok) throw new Error();
      const data = await res.json();
      const box = document.getElementById('session-list');
      const items = document.getElementById('session-items');
      items.innerHTML = "";

      const delSet = getDeletedSet();
      const sessions = (data.sessions || []).filter(s => !delSet.has(s.session_id));
      if (sessions.length === 0) {
        box.style.display = 'none';
        return;
      }
      box.style.display = 'block';

      sessions.forEach(s => {
        const row = document.createElement('div');
        row.className = 'session-item';
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';

        const btn = document.createElement('button');
        btn.textContent = s.title || s.session_id;
        btn.title = s.session_id;
        btn.style.flex = '1';
        btn.style.border = 'none';
        btn.style.background = 'transparent';
        btn.style.textAlign = 'left';
        btn.style.cursor = 'pointer';
        btn.onclick = () => {
          sessionId = s.session_id; // Ïù¥ ÏÑ∏ÏÖòÏúºÎ°ú Ï†ÑÌôò
          updateIdBadge();
          fetchHistory(sessionId);  // Ï†ÑÌôò Ï¶âÏãú ÌûàÏä§ÌÜ†Î¶¨ Î∂àÎü¨Ïò§Í∏∞
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = '‚ùå';
        delBtn.style.border = 'none';
        delBtn.style.background = 'transparent';
        delBtn.style.cursor = 'pointer';
        delBtn.style.marginLeft = '6px';
        delBtn.title = 'ÎåÄÌôî ÏÇ≠Ï†ú';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm('Ïù¥ ÎåÄÌôîÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
            deleteSession(s.session_id);
            fetchSessions();
          }
        };

        row.appendChild(btn);
        row.appendChild(delBtn);
        items.appendChild(row);
      });
    } catch (e) {
      // FRONTEND-ONLY FALLBACK
      const box = document.getElementById('session-list');
      const items = document.getElementById('session-items');
      if (!box || !items) return;
      items.innerHTML = "";
      const localList = lsGet(sessionListKey(userId), []);
      const delSet = getDeletedSet();
      if (localList.length === 0) { box.style.display = 'none'; return; }
      box.style.display = 'block';
      localList.filter(s => !delSet.has(s.sessionId)).slice(0, 5).forEach(s => {
        const row = document.createElement('div');
        row.className = 'session-item';
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';

        const btn = document.createElement('button');
        btn.textContent = s.title || s.sessionId;
        btn.title = s.sessionId;
        btn.style.flex = '1';
        btn.style.border = 'none';
        btn.style.background = 'transparent';
        btn.style.textAlign = 'left';
        btn.style.cursor = 'pointer';
        btn.onclick = () => {
          sessionId = s.sessionId;
          updateIdBadge();
          fetchHistory(sessionId);
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = '‚ùå';
        delBtn.style.border = 'none';
        delBtn.style.background = 'transparent';
        delBtn.style.cursor = 'pointer';
        delBtn.style.marginLeft = '6px';
        delBtn.title = 'ÎåÄÌôî ÏÇ≠Ï†ú';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm('Ïù¥ ÎåÄÌôîÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
            deleteSession(s.sessionId);
            fetchSessions();
          }
        };

        row.appendChild(btn);
        row.appendChild(delBtn);
        items.appendChild(row);
      });
    }
  }

  // ====== Î©îÏãúÏßÄ Ï†ÑÏÜ° & Ïä§Ìä∏Î¶¨Î∞ç ÏàòÏã†(SSE) ======
  async function sendMessage(customInput, isRegenerate = false) {
    const inputElem = document.getElementById("user-input");
    const input = customInput || inputElem.value.trim();
    if (input === "") return;

    let userMsgId;
    if (!isRegenerate) {
      userMsgId = appendUserMessage(input);
      if (!customInput) inputElem.value = "";
    }

    showLoading();

    try {
      const chatBox = document.getElementById("chat-box");
      loadingMessage = document.createElement("div");
      loadingMessage.className = "chat-message bot";
      loadingMessage.id = "loading-bot-msg";
      loadingMessage.innerHTML = `
        <div class="avatar">ü§ñ</div>
        <div class="chat-bubble loading"><span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></div>
        <span class="cancel-x" title="Ï∑®ÏÜåÌïòÍ∏∞" onclick="cancelRequest()">‚ùé</span>
      `;
      chatBox.appendChild(loadingMessage);
      scrollToBottom();

      loadingTimer = setTimeout(() => { cancelRequest(); }, 30000);

      controller = new AbortController();
      const response = await fetch(`${BACKEND_URL}/stream`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, session_id: sessionId, question: input }),
        signal: controller.signal
      });

      const reader = response.body.getReader();
      streamReader = reader;
      const decoder = new TextDecoder("utf-8");
      let buffer = "";
      let isFirst = true;
      let chatBubble = null;
      let currentText = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        let events = buffer.split("\n\n");
        buffer = events.pop();

        for (const evt of events) {
          const lines = evt.split("\n");
          for (const line of lines) {
            if (!line.startsWith("data:")) continue;
            let payload = line.slice(5).trim();

            if (payload === "[DONE]") continue;

            let textChunk = "";
            try {
              const parsed = JSON.parse(payload);
              textChunk = parsed.text ?? parsed.delta ?? "";
            } catch {
              textChunk = payload;
            }

            if (isFirst && loadingMessage && loadingMessage.parentNode) {
              const bubble = loadingMessage.querySelector(".chat-bubble");
              bubble.classList.remove("loading");
              bubble.innerHTML = "";
              chatBubble = bubble;
              isFirst = false;
              currentText = "";
            }

            if (chatBubble && textChunk) {
              currentText += textChunk;
              chatBubble.innerHTML = preserveWhitespace(currentText);
              scrollToBottom();
            }
          }
        }
      }

      clearTimeout(loadingTimer);

      if (loadingMessage && loadingMessage.parentNode) {
        const cancelBtn = loadingMessage.querySelector('.cancel-x');
        if (cancelBtn) cancelBtn.remove();
        loadingMessage.parentNode.removeChild(loadingMessage);
        appendBotMessage(currentText, input);
        loadingMessage = null;
      }

      // ÏùëÎãµ ÌõÑ ÏÑ∏ÏÖò Î™©Î°ù Í∞±Ïã†(ÏÉà ÏÑ∏ÏÖòÏùò Ï≤´ ÏßàÎ¨∏Ïù¥Î©¥ Î™©Î°ùÏóê Î∞òÏòÅ)
      fetchSessions();
    } catch (error) {
      clearTimeout(loadingTimer);
      if (loadingMessage && loadingMessage.parentNode) {
        loadingMessage.parentNode.removeChild(loadingMessage);
        loadingMessage = null;
        appendBotMessage("‚ö†Ô∏è ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî.");
      }
    }

    streamReader = null;
    hideLoading();
  }

  function sendRecommendedQuestion(text) { sendMessage(text); }

  // ====== ÏùåÏÑ± ÏûÖÎ†• ======
  let recognizing = false;
  let recognition = null;

  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "ko-KR";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = function() {
      recognizing = true;
      document.getElementById('voice-btn').setAttribute('aria-pressed', 'true');
    };
    recognition.onend = function() {
      recognizing = false;
      document.getElementById('voice-btn').setAttribute('aria-pressed', 'false');
    };
    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      document.getElementById('user-input').value = transcript;
      document.getElementById('user-input').focus();
    };
    recognition.onerror = function() {
      recognizing = false;
      document.getElementById('voice-btn').setAttribute('aria-pressed', 'false');
    };

    document.getElementById('voice-btn').onclick = function() {
      if (recognizing) { recognition.stop(); } else { recognition.start(); }
    };
  } else {
    document.getElementById('voice-btn').onclick = function() {
      alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî ÏùåÏÑ± ÏûÖÎ†•Ïù¥ ÏßÄÏõêÎêòÏßÄ ÏïäÏäµÎãàÎã§.');
    }
  }
</script>
</body>
</html>
